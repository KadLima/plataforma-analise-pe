<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <title>Formul√°rio de Autoavalia√ß√£o - An√°lise PE</title>
    <style>
        :root {
            --azul-gov-principal: #002776;
            --amarelo-gov-detalhe: #FFD700;
            --cinza-texto: #333333;
            --cinza-fundo: #f4f4f4;
            --branco: #ffffff;
            --verde-sucesso: #28a745;
            --vermelho-destaque: #dc3545;
            --cinza-borda: #ddd;
        }
        body { margin: 0; font-family: 'Segoe UI', Arial, sans-serif; background-color: var(--cinza-fundo); color: var(--cinza-texto); line-height: 1.6; }
        .main-header { background-color: var(--branco); box-shadow: 0 2px 5px rgba(0,0,0,0.1); padding: 0 5%; position: sticky; top: 0; z-index: 1000; }
        .main-nav { display: flex; justify-content: space-between; align-items: center; height: 70px; max-width: 1200px; margin: 0 auto; }
        .logo a { text-decoration: none; display: flex; align-items: center; gap: 12px; }
        .logo img { height: 45px; filter: drop-shadow(1px 1px 2px rgba(0, 0, 0, 0.5));}
        .logo .site-title { color: var(--azul-gov-principal); font-size: 1.2em; font-weight: bold; line-height: 1.2; }
        .logo .site-subtitle { color: var(--cinza-texto); font-size: 0.8em; display: block; }
        .main-nav ul { list-style: none; margin: 0; padding: 0; display: flex; gap: 20px; }
        .main-nav a { text-decoration: none; color: var(--cinza-texto); font-weight: 600; padding: 10px; border-bottom: 2px solid transparent; transition: all 0.3s ease; }
        .main-nav a:hover, .main-nav a.active { color: var(--azul-gov-principal); border-bottom-color: var(--amarelo-gov-detalhe); }
        .main-footer { text-align: center; padding: 20px; margin-top: 40px; background-color: var(--branco); font-size: 0.9em; position: relative; height: 60px; }
        .main-footer .footer-content { display: flex; justify-content: center; align-items: center; height: 100%; }
        .main-footer img { height: 110px; width: auto; position: absolute; right: 5%; top: 50%; transform: translateY(-50%); }
        main { padding: 40px 5%; }
        .container { max-width: 900px; margin: 0 auto; background: var(--branco); padding: 30px 40px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .form-section { margin-bottom: 40px; padding-bottom: 20px; border-bottom: 1px solid #eee; }
        .form-section:last-of-type { border-bottom: none; }
        .form-section h2 { color: var(--azul-gov-principal); border-bottom: 2px solid var(--amarelo-gov-detalhe); padding-bottom: 10px; margin-bottom: 20px; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; font-weight: 600; margin-bottom: 8px; }
        .form-group input, .form-group select { width: 100%; box-sizing: border-box; padding: 12px; border: 1px solid var(--cinza-borda); border-radius: 6px; font-size: 1em; }
        .btn { padding: 12px 25px; background-color: var(--azul-gov-principal); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 1em; font-weight: bold; transition: background-color .3s; }
        .btn:hover { background-color: #001a4d; }
        .btn:disabled { background-color: #ccc; cursor: not-allowed; }
        #requisitos-container { margin-top: 20px; }
        .requisito-card { border: 1px solid var(--cinza-borda); border-radius: 8px; margin-bottom: 20px; overflow: hidden; }
        .requisito-header { background-color: #f0f4ff; padding: 15px; font-weight: bold; }
        .requisito-body { padding: 15px; background-color: var(--branco); }
        .requisito-ajuda { font-size: 0.9em; color: #555; background-color: #fafafa; padding: 10px; border-radius: 4px; margin-bottom: 15px; }
        .requisito-actions { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; margin-bottom: 10px; }
        .btn-toggle { padding: 8px 16px; border: 1px solid var(--cinza-borda); background-color: var(--branco); border-radius: 20px; cursor: pointer; font-weight: 600; }
        .btn-toggle.active { background-color: var(--verde-sucesso); color: var(--branco); border-color: var(--verde-sucesso); }
        .btn-toggle[data-action*="nao"].active { background-color: var(--vermelho-destaque); border-color: var(--vermelho-destaque); color: var(--branco); }
        .link-comprovante-wrapper { display: none; width: 100%; }
        .link-comprovante-wrapper.show { display: block; }
        .link-comprovante-wrapper .link-input { width: 100%; box-sizing: border-box; padding: 8px; }
        .download-guide { background-color: #e9eef5; padding: 15px; border-radius: 6px; margin-bottom: 30px; text-align: center; }
        .download-guide a { font-weight: bold; color: var(--azul-gov-principal); text-decoration: none; }
        .download-guide a:hover { text-decoration: underline; }
        .progress-bar { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 50px; position: relative; }
        .progress-bar::before { content: ''; position: absolute; top: 15px; left: 15%; right: 15%; height: 2px; background-color: var(--cinza-borda); z-index: 0; }
        .step { text-align: center; position: relative; z-index: 1; width: 120px; }
        .step-number { width: 30px; height: 30px; border-radius: 50%; background-color: var(--cinza-fundo); color: var(--cinza-texto); display: inline-flex; align-items: center; justify-content: center; font-weight: bold; border: 2px solid var(--cinza-borda); transition: all 0.4s; }
        .step-label { margin-top: 8px; font-size: 0.9em; color: #999; transition: color 0.4s; }
        .step.active .step-number { background-color: var(--azul-gov-principal); border-color: var(--azul-gov-principal); color: var(--branco); }
        .step.active .step-label { color: var(--azul-gov-principal); font-weight: bold; }
        .evidence-container { padding-top: 10px; border-top: 1px solid #f0f0f0; margin-top: 10px; }
        .evidence-list { list-style: none; padding: 0; margin: 0 0 10px 0; }
        .evidence-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: #f8f9fa;
            padding: 8px 12px;
            border-radius: 6px;
            margin-bottom: 5px;
            font-size: 0.9em;
        }
        .evidence-item a {
            color: var(--azul-gov-principal);
            word-break: break-all;
            flex-grow: 1;
        }
        .remove-evidence-btn {
            background: none;
            border: none;
            color: var(--vermelho-destaque);
            cursor: pointer;
            font-size: 1.5em;
            padding: 0 5px;
            margin-left: 10px;
            line-height: 1;
        }
        .add-evidence-buttons {
            display: flex;
            gap: 10px;
        }
        .btn-add-evidence {
            padding: 6px 12px;
            font-size: 0.8em;
            border-radius: 6px;
            border: 1px solid var(--azul-gov-principal);
            background-color: var(--branco);
            color: var(--azul-gov-principal);
            font-weight: bold;
            cursor: pointer;
        }
        .btn-add-evidence:hover {
            background-color: #e9eef5;
        }
        
        .comment-container {
            margin-top: 15px;
            border-top: 1px solid #f0f0f0;
            padding-top: 15px;
        }
        .secretaria-comment {
            width: 100%;
            box-sizing: border-box;
            padding: 10px;
            border: 1px solid var(--cinza-borda);
            border-radius: 6px;
            font-family: 'Segoe UI', Arial, sans-serif;
            font-size: 0.9em;
            min-height: 70px;
            resize: none;
        }
        
        .sub-requisito-container {
            margin-top: 15px;
        }
        .sub-requisito {
            margin-bottom: 20px;
            padding-left: 15px;
            border-left: 3px solid #e9eef5;
        }
        .sub-requisito-label {
            font-weight: 600;
            margin-bottom: 8px;
            display: block;
        }
        
        .sub-requisito.hidden {
            display: none;
        }

        .secretaria-display-box {
            background-color: #e9ecef;
            padding: 12px;
            border-radius: 6px;
            font-weight: 500;
            color: #495057;
        }

        #logout-btn {
            cursor: pointer;
        }

    </style>
</head>
<body>
    <header class="main-header">
        <nav class="main-nav">
            <div class="logo">
                <a href="/"><img src="/assets/logo-header.png" alt="Logo do Governo de Pernambuco"><div><span class="site-title">An√°lise de Sites</span><span class="site-subtitle">Portal da Transpar√™ncia</span></div></a>
            </div>
            <ul id="nav-links"></ul>
        </nav>
    </header>
    <main>
        <div class="container">
            <div class="progress-bar">
                <div class="step active" id="progress-step-1"><div class="step-number">1</div><div class="step-label">Identifica√ß√£o</div></div>
                <div class="step" id="progress-step-2"><div class="step-number">2</div><div class="step-label">Pr√©-Valida√ß√£o</div></div>
                <div class="step" id="progress-step-3"><div class="step-number">3</div><div class="step-label">Preenchimento</div></div>
            </div>          
            <div class="download-guide">
                <p style="margin:0;">üìÑ Precisa de ajuda? <a href="/assets/guia-transparencia.pdf" download>Clique aqui para baixar o Guia de Transpar√™ncia Ativa.</a></p>
            </div>
            <div class="form-section">
                <h2>Passo 1: Identifica√ß√£o</h2>
                <div class="form-group">
                    <label>√ìrg√£o/Entidade</label>
                    <div id="secretaria-display" class="secretaria-display-box">Carregando seus dados...</div>
                    <input type="hidden" id="secretaria-id-hidden">
                </div>
                <div class="form-group"><label for="url-manual">URL do Site a ser Avaliado</label><input type="url" id="url-manual" placeholder="https://www.sitedasecretaria.pe.gov.br"></div>
                <div class="form-group"><label for="responsavel-nome">Nome do Respons√°vel pelo preenchimento</label><input type="text" id="responsavel-nome" placeholder="Digite seu nome completo"></div>
                <div class="form-group"><label for="responsavel-email">E-mail do Respons√°vel</label><input type="email" id="responsavel-email" placeholder="Digite seu e-mail para contato"></div>
            </div>
            <div class="form-section">
                <h2>Passo 2: Pr√©-Valida√ß√£o Autom√°tica</h2>
                <p>Antes de come√ßar, nossa ferramenta pode verificar automaticamente alguns requisitos para voc√™. Clique no bot√£o abaixo para iniciar a verifica√ß√£o no site da secretaria selecionada.</p>
                <button id="pre-validar-btn" class="btn">Iniciar Pr√©-Valida√ß√£o</button>
                <div id="pre-validacao-resultado" style="margin-top: 15px;"></div>
            </div>
            <div class="form-section">
                <h2>Passo 3: Preenchimento dos Requisitos</h2>
                <div id="requisitos-container"><p>Aguardando a pr√©-valida√ß√£o para carregar os requisitos...</p></div>
            </div>
            <div style="text-align: right;"><button id="enviar-avaliacao-btn" class="btn" disabled>Enviar Avalia√ß√£o</button></div>
        </div>
    </main>
    <footer class="main-footer">
        <div class="footer-content">
            <p>&copy; 2025 Governo de Pernambuco. Todos os direitos reservados. <a href="/admin" id="admin-footer-link">√Årea Administrativa</a></p>
            <img src="/assets/logo-footer.png" alt="Logo da Controladoria-Geral do Estado de Pernambuco">
        </div>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', () => {

            // --- FUN√á√ÉO AUXILIAR DEBOUNCE ---
            function debounce(func, wait) {
                let timeout;
                return function executedFunction(...args) {
                    const later = () => {
                        clearTimeout(timeout);
                        func(...args);
                    };
                    clearTimeout(timeout);
                    timeout = setTimeout(later, wait);
                };
            };

            // --- VARI√ÅVEIS GLOBAIS DO SCRIPT ---
            const secretariaHiddenInput = document.getElementById('secretaria-id-hidden');
            const urlManualInput = document.getElementById('url-manual');
            const nomeResponsavelInput = document.getElementById('responsavel-nome');
            const emailResponsavelInput = document.getElementById('responsavel-email');
            const preValidarBtn = document.getElementById('pre-validar-btn');
            const preValidacaoResultado = document.getElementById('pre-validacao-resultado');
            const requisitosContainer = document.getElementById('requisitos-container');
            const enviarAvaliacaoBtn = document.getElementById('enviar-avaliacao-btn');
            const step1 = document.getElementById('progress-step-1');
            const step2 = document.getElementById('progress-step-2');
            const step3 = document.getElementById('progress-step-3');
            
            const debouncedSalvarRascunho = debounce(salvarRascunho, 750); 
            
            let todosOsRequisitos = [];
            let linksEncontradosAutomaticamente = [];
            let preventUnload = false;
            let usuarioEscolheuCarregarRascunho = null;
            let rascunhoPendente = null; 

            nomeResponsavelInput.addEventListener('input', debouncedSalvarRascunho);
            emailResponsavelInput.addEventListener('input', debouncedSalvarRascunho);

            requisitosContainer.addEventListener('input', (event) => {
                if (event.target.matches('.secretaria-comment')) {
                    debouncedSalvarRascunho(); 
                }
            });

            requisitosContainer.addEventListener('click', (event) => {
                const target = event.target;
                const requisitoCard = target.closest('.requisito-card');
                if (!requisitoCard) return;

                const requisitoId = requisitoCard.dataset.requisitoId;
                if (!requisitoId) return;

                if (target.matches('.requisito-actions .btn-toggle[data-action]')) {
                    const action = target.dataset.action;
                    const idFromAction = action.split('-')[1];

                    if (idFromAction === requisitoId && (action.startsWith('sim-') || action.startsWith('nao-'))) {
                        console.log(`Bot√£o Toggle Clicado: Action=${action}, RequisitoID=${requisitoId}`);

                        const isSimClick = action.startsWith('sim-');
                        const wrapperId = `evidence-wrapper-${requisitoId}`;
                        const wrapper = requisitoCard.querySelector(`#${wrapperId}`);
                        const simButton = requisitoCard.querySelector(`[data-action="sim-${requisitoId}"]`);
                        const naoButton = requisitoCard.querySelector(`[data-action="nao-${requisitoId}"]`);

                        if (simButton && naoButton) {
                            simButton.classList.remove('active');
                            naoButton.classList.remove('active');
                            target.classList.add('active');

                            if (wrapper) {
                                if (isSimClick) {
                                    wrapper.classList.add('show');
                                } else {
                                    wrapper.classList.remove('show');
                                }
                            }
                            salvarRascunho(); 
                        }
                        return; 
                    }
                }

                if (target.matches('.add-link-btn')) {
                    if(target.dataset.requisitoId === requisitoId) {
                        console.log(`ADICIONAR LINK Clicado para Req ${requisitoId}`); 
                        Swal.fire({
                            title: 'Adicionar Evid√™ncia Manual',
                            input: 'url',
                            inputLabel: 'URL do Link de Comprova√ß√£o',
                            inputPlaceholder: 'www.exemplo.com.br', 
                            inputAttributes: { autocapitalize: 'off', autocorrect: 'off' },
                            showCancelButton: true,
                            confirmButtonText: 'Adicionar Link',
                            cancelButtonText: 'Cancelar',
                            confirmButtonColor: 'var(--azul-gov-principal)',
                            cancelButtonColor: '#6c757d',
                            showLoaderOnConfirm: true,

                            inputValidator: (value) => {
                                if (!value) {
                                    return 'Voc√™ precisa digitar um endere√ßo web!';
                                }
                                if (/\s/.test(value)) { 
                                    return 'O endere√ßo n√£o pode conter espa√ßos.';
                                }
                                if (value.length > 0 && !value.includes('.')) { 
                                    return 'Insira um endere√ßo v√°lido (ex: www.exemplo.com)';
                                }
                                return null; 
                            },

                            preConfirm: (value) => {
                                let finalUrl = value.trim();
                                if (!/^(https?:\/\/|\/\/)/i.test(finalUrl)) {
                                    finalUrl = 'https://' + finalUrl;
                                }
                                return finalUrl; 
                            },
                            
                            allowOutsideClick: () => !Swal.isLoading()
                        }).then((result) => {
                            if (result.isConfirmed && result.value) {
                                const url = result.value; 
                                const evidenceList = target.closest('.evidence-container')?.querySelector('.evidence-list');
                                if (evidenceList) {
                                    const newItem = document.createElement('li');
                                    newItem.className = 'evidence-item';
                                    newItem.dataset.link = url;
                                    newItem.innerHTML = `<a href="${url}" target="_blank" title="${url}">${url}</a><button class="remove-evidence-btn" title="Remover Evid√™ncia">&times;</button>`;
                                    evidenceList.appendChild(newItem);

                                    const removeBtn = newItem.querySelector('.remove-evidence-btn');
                                    removeBtn.addEventListener('click', function() {
                                        this.closest('.evidence-item').remove();
                                        salvarRascunho();
                                    });
                                    salvarRascunho();
                                }
                            }
                        });
                        return; 
                    }
                }

                if (target.matches('.add-fixo-btn')) {
                    if (target.dataset.requisitoId === requisitoId) {
                        const linkFixo = target.dataset.linkFixo;
                        const evidenceList = target.closest('.evidence-container')?.querySelector('.evidence-list');
                        if (evidenceList && linkFixo) {
                            let exists = false;
                            evidenceList.querySelectorAll('.evidence-item').forEach(item => { if (item.dataset.link === linkFixo) exists = true; });
                            if (!exists) {
                                const newItem = document.createElement('li');
                                newItem.className = 'evidence-item';
                                newItem.dataset.link = linkFixo;
                                newItem.innerHTML = `<a href="${linkFixo}" target="_blank" title="${linkFixo}">${linkFixo}</a><button class="remove-evidence-btn" title="Remover Evid√™ncia">&times;</button>`;
                                evidenceList.appendChild(newItem);
                                const removeBtn = newItem.querySelector('.remove-evidence-btn');
                                removeBtn.addEventListener('click', function() { this.closest('.evidence-item').remove(); salvarRascunho(); });
                                salvarRascunho();
                            } else {
                                Swal.fire({ toast: true, position: 'top-end', icon: 'info', title: 'Link fixo j√° adicionado.', showConfirmButton: false, timer: 1500 });
                            }
                        }
                        return; 
                    }
                }

                if (target.matches('.remove-evidence-btn')) {
                    event.stopPropagation(); 
                    target.closest('.evidence-item')?.remove();
                    salvarRascunho();
                    return; 
                }
            });

            function adicionarListenersRemoverEvidencia() {
                requisitosContainer.querySelectorAll('.remove-evidence-btn').forEach(btn => {
                    const listenerAttached = btn.getAttribute('data-listener-attached');
                    if (!listenerAttached) {
                        btn.addEventListener('click', function(event) {
                            event.stopPropagation(); 
                            this.closest('.evidence-item').remove();
                            salvarRascunho();
                        });
                        btn.setAttribute('data-listener-attached', 'true');
                    }
                });
            }

            function carregarLinksAutomaticos() {
                const secretariaId = secretariaHiddenInput.value;
                if (!secretariaId) return [];
                const linksSalvos = localStorage.getItem(`links_automaticos_${secretariaId}`);
                if (linksSalvos) {
                    console.log(`üìÇ Links autom√°ticos carregados do cache:`, JSON.parse(linksSalvos));
                    return JSON.parse(linksSalvos);
                }
                return [];
            }

            function salvarLinksAutomaticos(links) {
                const secretariaId = secretariaHiddenInput.value;
                if (!secretariaId) return;
                localStorage.setItem(`links_automaticos_${secretariaId}`, JSON.stringify(links));
                console.log(`üíæ Links autom√°ticos salvos para secretaria ${secretariaId}`);
            }

            function verificarRascunhoAoCarregar() {
                const secretariaId = secretariaHiddenInput.value;
                if (!secretariaId) {
                    console.log("Aguardando ID da secretaria para verificar rascunho...");
                    setTimeout(verificarRascunhoAoCarregar, 300);
                    return;
                }
                console.log(`Verificando rascunho para secretaria ID: ${secretariaId}`);

                const rascunhoSalvo = localStorage.getItem(`rascunho_avaliacao_${secretariaId}`);
                if (rascunhoSalvo) {
                    const rascunho = JSON.parse(rascunhoSalvo);
                    const temDadosSignificativos = rascunho.nomeResponsavel || rascunho.emailResponsavel || (rascunho.respostas && Object.keys(rascunho.respostas).length > 0);

                    if (temDadosSignificativos) {
                        console.log("Rascunho significativo encontrado. Exibindo prompt...");
                        Swal.fire({
                            title: 'Progresso Salvo Encontrado',
                            text: "Encontramos um progresso n√£o finalizado para este √≥rg√£o. Deseja continuar de onde parou?",
                            icon: 'info',
                            iconColor: 'var(--azul-gov-principal)',
                            showCancelButton: true,
                            confirmButtonText: 'Sim, continuar',
                            cancelButtonText: 'N√£o, come√ßar do zero',
                            confirmButtonColor: 'var(--azul-gov-principal)',
                            cancelButtonColor: '#6c757d',
                            allowOutsideClick: false
                        }).then((result) => {
                            if (result.isConfirmed) {
                                console.log("Usu√°rio escolheu CARREGAR rascunho.");
                                usuarioEscolheuCarregarRascunho = true;
                                carregarRascunhoCompleto(rascunho);
                                restaurarEstadoPreValidacao(); 
                            } else {
                                console.log("Usu√°rio escolheu COME√áAR DO ZERO.");
                                usuarioEscolheuCarregarRascunho = false;
                                limparFormularioCompleto();
                            }
                        });
                    } else {
                        console.log("Rascunho encontrado, mas sem dados significativos. Ignorando prompt.");
                        usuarioEscolheuCarregarRascunho = false;
                    }
                } else {
                    console.log("Nenhum rascunho encontrado.");
                    usuarioEscolheuCarregarRascunho = false;
                }
            }

            function limparFormularioCompleto() {
                const secretariaId = secretariaHiddenInput.value;
                if (secretariaId) {
                    localStorage.removeItem(`rascunho_avaliacao_${secretariaId}`);
                    localStorage.removeItem(`links_automaticos_${secretariaId}`);
                    nomeResponsavelInput.value = '';
                    emailResponsavelInput.value = '';
                    preValidarBtn.textContent = 'Iniciar Pr√©-Valida√ß√£o';
                    preValidarBtn.style.backgroundColor = '';
                    preValidarBtn.style.cursor = '';
                    preValidarBtn.disabled = false;
                    urlManualInput.disabled = false;
                    step1.classList.add('active');
                    step2.classList.remove('active');
                    step3.classList.remove('active');
                    preValidacaoResultado.innerHTML = '';
                    requisitosContainer.innerHTML = '<p>Aguardando a pr√©-valida√ß√£o para carregar os requisitos...</p>';
                    linksEncontradosAutomaticamente = [];
                    rascunhoPendente = null;
                    console.log(`‚úÖ Formul√°rio completamente zerado para secretaria ${secretariaId}`);
                }
            }

            function carregarRascunhoCompleto(rascunho) {
                nomeResponsavelInput.value = rascunho.nomeResponsavel || '';
                emailResponsavelInput.value = rascunho.emailResponsavel || '';
                if (document.querySelectorAll('.requisito-card').length > 0) {
                    aplicarRascunhoAosRequisitos(rascunho);
                } else {
                    rascunhoPendente = rascunho; 
                }
            }

            function aplicarRascunhoAosRequisitos(rascunho) {
                document.querySelectorAll('.requisito-card').forEach(card => {
                    const id = card.dataset.requisitoId;
                    const resposta = rascunho.respostas && rascunho.respostas[id];
                    
                    const simBtn = card.querySelector(`[data-action="sim-${id}"]`);
                    const naoBtn = card.querySelector(`[data-action="nao-${id}"]`);
                    const wrapper = card.querySelector(`#evidence-wrapper-${id}`);

                    if (resposta && simBtn && naoBtn) {
                        if (resposta.sim === true) {
                            simBtn.classList.add('active');
                            naoBtn.classList.remove('active');
                            if (wrapper) wrapper.classList.add('show');
                        } else {
                            naoBtn.classList.add('active');
                            simBtn.classList.remove('active');
                            if (wrapper) wrapper.classList.remove('show');
                        }

                        const commentEl = card.querySelector('.secretaria-comment');
                        if (commentEl && resposta.comentario) {
                            commentEl.value = resposta.comentario;
                        }

                        const evidenceList = card.querySelector('.evidence-list');
                        if (evidenceList && Array.isArray(resposta.evidencias)) {
                            evidenceList.innerHTML = '';
                            resposta.evidencias.forEach(url => {
                                if (url && typeof url === 'string') {
                                    const newItem = document.createElement('li');
                                    newItem.className = 'evidence-item';
                                    newItem.dataset.link = url;
                                    newItem.innerHTML = `<a href="${url}" target="_blank" title="${url}">${url}</a><button class="remove-evidence-btn" title="Remover Evid√™ncia">&times;</button>`;
                                    evidenceList.appendChild(newItem);
                                }
                            });
                        }
                    } else if (simBtn && naoBtn) {
                        naoBtn.classList.add('active');
                        simBtn.classList.remove('active');
                        if (wrapper) wrapper.classList.remove('show');
                    }
                });
                console.log(`Rascunho aplicado aos requisitos.`);
                adicionarListenersRemoverEvidencia(); 
            }

            async function populateSecretarias() {
                console.log("1. Iniciando populateSecretarias...");
                try {
                    const authToken = localStorage.getItem('authToken');
                    const userResponse = await fetch('/verify-token', {
                        headers: { 'Authorization': `Bearer ${authToken}` }
                    });
                    if (!userResponse.ok) throw new Error('N√£o foi poss√≠vel verificar os dados do usu√°rio.');
                    const userData = await userResponse.json();
                    
                    const secretariaId = userData.user.secretariaId;
                    const secResponse = await fetch(`/secretarias/${secretariaId}`);
                    if (!secResponse.ok) throw new Error('N√£o foi poss√≠vel carregar os dados da sua secretaria.');
                    
                    const secretaria = await secResponse.json();
                    console.log("7. Dados da secretaria recebidos:", secretaria);

                    const secretariaDisplay = document.getElementById('secretaria-display');
                    secretariaDisplay.textContent = `${secretaria.nome} (${secretaria.sigla})`;
                    secretariaHiddenInput.value = secretaria.id;
                    urlManualInput.value = secretaria.url;
                    urlManualInput.disabled = false;
                    
                    linksEncontradosAutomaticamente = carregarLinksAutomaticos();
                    await verificarAvaliacaoExistente(secretariaId);

                    setTimeout(() => {
                        verificarRascunhoAoCarregar(); 
                    }, 100);

                } catch (error) {
                    document.getElementById('secretaria-display').textContent = 'Erro ao carregar seus dados.';
                    console.error("ERRO DETALHADO em populateSecretarias:", error);
                }
            }

            function restaurarEstadoPreValidacao() {
                const secretariaId = secretariaHiddenInput.value;
                if (!secretariaId) return;

                if (usuarioEscolheuCarregarRascunho === false) {
                    console.log("‚ùå Usu√°rio escolheu n√£o carregar rascunho, pulando restaura√ß√£o...");
                    return;
                }

                const rascunhoSalvo = localStorage.getItem(`rascunho_avaliacao_${secretariaId}`);
                const linksSalvos = localStorage.getItem(`links_automaticos_${secretariaId}`);
                
                if (linksSalvos || rascunhoSalvo) {
                    console.log("üìÅ Links autom√°ticos ou rascunho encontrados, restaurando estado...");
                    
                    preValidarBtn.textContent = 'Pr√©-Valida√ß√£o Conclu√≠da';
                    preValidarBtn.style.backgroundColor = 'var(--verde-sucesso)';
                    preValidarBtn.style.cursor = 'default';
                    preValidarBtn.disabled = true;
                    urlManualInput.disabled = true;
                    
                    step1.classList.remove('active');
                    step2.classList.add('active');
                    step3.classList.add('active');
                    
                    if (linksEncontradosAutomaticamente.length > 0) {
                        console.log(`Renderizando requisitos com ${linksEncontradosAutomaticamente.length} links...`);
                        renderRequisitos(linksEncontradosAutomaticamente); 

                        const urlPrincipalRestaurada = document.getElementById('url-manual').value.trim();
                        const req6ConsideradoRestaurado = linksEncontradosAutomaticamente.some(l => l.alvo === 'KEYWORD:site-exists') || !!urlPrincipalRestaurada;
                        let contagemExibidaRestaurada = linksEncontradosAutomaticamente.length;
                        if (req6ConsideradoRestaurado && !linksEncontradosAutomaticamente.some(l => l.alvo === 'KEYWORD:site-exists')) {
                             contagemExibidaRestaurada++;
                        }
                        
                        preValidacaoResultado.innerHTML = `<h4>Pr√©-Valida√ß√£o Carregada do Cache</h4><p>Foram encontrados <strong>${contagemExibidaRestaurada}</strong> links obrigat√≥rios na √∫ltima verifica√ß√£o </p>`;

                    } else if (rascunhoSalvo) {
                        preValidacaoResultado.innerHTML = `<h4>Progresso Anterior Carregado</h4><p>Seu progresso anterior foi restaurado com sucesso.</p>`;
                        renderRequisitos([]); 
                    }
                }
            }

            async function verificarAvaliacaoExistente(secretariaId) {
                try {
                    const authToken = localStorage.getItem('authToken');
                    const response = await fetch('/api/my-avaliacoes', {
                        headers: { 'Authorization': `Bearer ${authToken}`, 'Content-Type': 'application/json' }
                    });

                    if (response.ok) {
                        const avaliacoes = await response.json();
                        const avaliacaoAtiva = avaliacoes.find(av => 
                            av.secretariaId === parseInt(secretariaId) && 
                            av.status !== 'PENDENTE_SECRETARIA' &&
                            av.status !== 'FINALIZADA'
                        );

                        if (avaliacaoAtiva) {
                            Swal.fire({
                                title: 'Avalia√ß√£o J√° Submetida',
                                html: `Esta secretaria j√° possui uma avalia√ß√£o em andamento.<br><br>
                                       <strong>Status:</strong> ${avaliacaoAtiva.status}<br>
                                       <strong>URL:</strong> ${avaliacaoAtiva.urlSecretaria}<br><br>
                                       Voc√™ pode acompanhar o andamento na sua √°rea pessoal.`,
                                icon: 'info',
                                iconColor: 'var(--azul-gov-principal)',
                                confirmButtonText: 'Ir para Minha √Årea',
                                confirmButtonColor: 'var(--azul-gov-principal)',
                                showCancelButton: true,
                                cancelButtonText: 'Continuar no Formul√°rio' 
                            }).then((result) => {
                                if (result.isConfirmed) {
                                    window.location.href = '/dashboard';
                                }
                            });
                        }
                    }
                } catch (error) {
                    console.log('Erro ao verificar avalia√ß√µes existentes:', error);
                }
            }

            function salvarRascunho() {
                const secretariaId = secretariaHiddenInput.value;
                if (!secretariaId) return;

                const rascunho = {
                    nomeResponsavel: nomeResponsavelInput.value,
                    emailResponsavel: emailResponsavelInput.value,
                    respostas: {}
                };
                let hasData = false; 

                document.querySelectorAll('.requisito-card').forEach(card => {
                    const id = card.dataset.requisitoId;
                    
                    const simBtn = card.querySelector(`[data-action="sim-${id}"]`); // Seletor corrigido
                    const atendeSim = simBtn ? simBtn.classList.contains('active') : false;
                    const comentario = card.querySelector('.secretaria-comment')?.value || '';
                    const evidencias = [];

                    card.querySelectorAll('.evidence-list .evidence-item').forEach(item => {
                        if (item.dataset.link) {
                            evidencias.push(item.dataset.link);
                        }
                    });

                    const naoBtn = card.querySelector(`[data-action="nao-${id}"]`); // Seletor corrigido
                    const naoAtivo = naoBtn ? naoBtn.classList.contains('active') : false;
                    if (atendeSim || naoAtivo || comentario || evidencias.length > 0) {
                        rascunho.respostas[id] = {
                            sim: atendeSim,
                            comentario: comentario,
                            evidencias: evidencias
                        };
                        hasData = true; 
                    }
                });

                if (hasData) {
                    localStorage.setItem(`rascunho_avaliacao_${secretariaId}`, JSON.stringify(rascunho));
                    console.log(`Rascunho para secretaria ${secretariaId} salvo.`);
                    preventUnload = true; 

                    Swal.fire({
                        toast: true,
                        position: 'top-end', 
                        icon: 'success',
                        title: 'Rascunho salvo!',
                        showConfirmButton: false,
                        timer: 1500, 
                        timerProgressBar: true,
                        didOpen: (toast) => { 
                            toast.addEventListener('mouseenter', Swal.stopTimer)
                            toast.addEventListener('mouseleave', Swal.resumeTimer)
                        }
                    });
                } else {
                    localStorage.removeItem(`rascunho_avaliacao_${secretariaId}`);
                    console.log(`Rascunho para secretaria ${secretariaId} limpo (vazio).`);
                    preventUnload = false; 
                }
            }

            function limparRascunho() {
                const secretariaId = secretariaHiddenInput.value;
                if (secretariaId) {
                    localStorage.removeItem(`rascunho_avaliacao_${secretariaId}`);
                    localStorage.removeItem(`links_automaticos_${secretariaId}`);
                    console.log(`Rascunho para secretaria ${secretariaId} limpo.`);
                    preventUnload = false;
                }
            }

            window.addEventListener('beforeunload', (event) => {
                if (preventUnload) {
                    event.preventDefault();
                    event.returnValue = 'Voc√™ tem altera√ß√µes n√£o salvas. Tem certeza que deseja sair?';
                    return 'Voc√™ tem altera√ß√µes n√£o salvas. Tem certeza que deseja sair?';
                }
            });

            async function renderRequisitos(linksEncontrados) {
                const urlPrincipal = document.getElementById('url-manual').value.trim();
                try {
                    requisitosContainer.innerHTML = '<p>Carregando requisitos...</p>';
                    step2.classList.remove('active');
                    step3.classList.add('active');

                    let linksParaRenderizar = [...linksEncontrados];
                    const req6JaEncontrado = linksEncontrados.some(l => l.alvo === 'KEYWORD:site-exists');
                    
                    if (!req6JaEncontrado && urlPrincipal) {
                        linksParaRenderizar.push({
                            alvo: 'KEYWORD:site-exists',
                            origem: urlPrincipal
                        });
                    }
                    
                    console.log(`üî¢ Total de links para renderizar: ${linksParaRenderizar.length} (incluindo site-exists: ${!req6JaEncontrado ? 'adicionado' : 'j√° existe'})`);
                    
                    if (todosOsRequisitos.length === 0) {
                        const response = await fetch('/requisitos');
                        if (!response.ok) throw new Error('Falha ao buscar os requisitos.');
                        todosOsRequisitos = await response.json();
                    }

                    requisitosContainer.innerHTML = '';
                    todosOsRequisitos.forEach(req => {
                        const resultadoEncontrado = linksParaRenderizar.find(res => res.alvo === req.linkFixo);
                        const isAutoValidated = !!resultadoEncontrado;
                        
                        const requisitoCard = document.createElement('div');
                        requisitoCard.className = 'requisito-card';
                        requisitoCard.dataset.requisitoId = req.id;
                        
                        let actionsHTML = '';

                        if (isAutoValidated) {
                            requisitoCard.dataset.foiAutomatico = 'true';
                            
                            const linkAlvo = resultadoEncontrado.alvo;
                            const linkOrigem = resultadoEncontrado.origem;
                            const linkExibido = linkAlvo === 'KEYWORD:site-exists' ? linkOrigem : linkAlvo;

                            actionsHTML = `
                                <div class="requisito-actions">
                                     <button class="btn-toggle active" data-action="sim-${req.id}" data-atende="true">Sim</button>
                                    <button class="btn-toggle" data-action="nao-${req.id}" data-atende="false">N√£o</button>
                                </div>
                                <div class="link-comprovante-wrapper show">
                                    <input type="url" class="link-input" value="${linkExibido}" readonly style="background-color: #e9e9e9;">
                                </div>
                                <div style="font-size: 0.9em; margin-top: 10px;">
                                    <span style="color: var(--verde-sucesso); font-weight: bold;">‚úîÔ∏è Verificado Automaticamente</span><br>
                                    <span class="link-meta"><strong>Encontrado em:</strong> <a href="${linkOrigem}" target="_blank">${linkOrigem}</a></span>
                                </div>`;
                        } else {
                            requisitoCard.dataset.foiAutomatico = 'false';
                            actionsHTML = `
                                <div class="requisito-actions">
                                    <span>Atende ao requisito?</span>
                                     <button class="btn-toggle" data-action="sim-${req.id}" data-atende="true">Sim</button>
                                    <button class="btn-toggle active" data-action="nao-${req.id}" data-atende="false">N√£o</button>
                                </div>
                                <div class="link-comprovante-wrapper" id="evidence-wrapper-${req.id}"> 
                                    <div class="evidence-container">
                                        <ul class="evidence-list" id="evidence-list-${req.id}"></ul> 
                                        <div class="add-evidence-buttons">
                                            <button class="btn-add-evidence add-link-btn" data-requisito-id="${req.id}">+ Adicionar Link</button>
                                             ${req.linkFixo && !req.linkFixo.startsWith('KEYWORD:') ?
                                                `<button class="btn-add-evidence add-fixo-btn" data-requisito-id="${req.id}" data-link-fixo="${req.linkFixo}">+ Adicionar Link Fixo (${req.linkFixo.substring(0,20)}...)</button>` : ''
                                             }
                                        </div>
                                    </div>
                                </div>
                                <div class="comment-container">
                                    <textarea class="secretaria-comment" id="comment-${req.id}" placeholder="Adicionar coment√°rio ou justificativa (opcional)..."></textarea> 
                                </div>`;
                        }

                        requisitoCard.innerHTML = `
                            <div class="requisito-header"><span>${req.texto} (Pontua√ß√£o: ${req.pontuacao})</span></div>
                            <div class="requisito-body">
                                <div class="requisito-ajuda"><strong>Guia:</strong> ${req.textoAjuda}</div>
                                ${actionsHTML}
                            </div>`;
                        requisitosContainer.appendChild(requisitoCard);
                    });
                    enviarAvaliacaoBtn.disabled = false;

                    if (rascunhoPendente) {
                        aplicarRascunhoAosRequisitos(rascunhoPendente);
                        rascunhoPendente = null;
                    }

                } catch (error) {
                    console.error(error);
                    requisitosContainer.innerHTML = '<p style="color: red;">Erro ao carregar os requisitos.</p>';
                }
            }

            preValidarBtn.addEventListener('click', async () => {
                const urlParaVerificar = urlManualInput.value.trim();
                if (!urlParaVerificar) {
                    alert('Por favor, digite a URL do site a ser avaliado.');
                    return;
                }
                preValidarBtn.disabled = true;
                preValidarBtn.textContent = 'Verificando...';
                preValidacaoResultado.innerHTML = '<p>Iniciando varredura no site... Isso pode levar alguns minutos.</p>';
                step1.classList.remove('active');
                step2.classList.add('active');
                try {
                    const response = await fetch('/pre-validate', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ urlSecretaria: urlParaVerificar }),
                    });
                    if (!response.ok) throw new Error('O servidor retornou um erro durante a pr√©-valida√ß√£o.');
                    const resultado = await response.json();
                    linksEncontradosAutomaticamente = resultado;
                    
                    salvarLinksAutomaticos(linksEncontradosAutomaticamente);

                    const urlPrincipal = document.getElementById('url-manual').value.trim();
                    const req6Considerado = linksEncontradosAutomaticamente.some(l => l.alvo === 'KEYWORD:site-exists') || !!urlPrincipal;
                    const contagemExibida = linksEncontradosAutomaticamente.length + (req6Considerado && !linksEncontradosAutomaticamente.some(l => l.alvo === 'KEYWORD:site-exists') ? 1 : 0);

                    preValidacaoResultado.innerHTML = `<h4>Verifica√ß√£o Autom√°tica Conclu√≠da!</h4><p>Foram encontrados <strong>${contagemExibida}</strong> links obrigat√≥rios (incluindo verifica√ß√£o de exist√™ncia do site).</p>`;
                    
                    await renderRequisitos(linksEncontradosAutomaticamente);
                    preValidarBtn.textContent = 'Pr√©-Valida√ß√£o Conclu√≠da';
                    preValidarBtn.style.backgroundColor = 'var(--verde-sucesso)';
                    preValidarBtn.style.cursor = 'default';
                    urlManualInput.disabled = true;
                } catch (error) {
                    preValidacaoResultado.innerHTML = `<p style="color: red;">Ocorreu um erro: ${error.message}</p>`;
                    preValidarBtn.disabled = false;
                    preValidarBtn.textContent = 'Tentar Pr√©-Valida√ß√£o Novamente';
                } 
            });

            async function enviarEmailConfirmacao(emailDestinatario, nomeResponsavel, nomeSecretaria, urlSecretaria) {
                try {
                    const response = await fetch('/api/enviar-email-confirmacao', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                        },
                        body: JSON.stringify({
                            email: emailDestinatario,
                            nomeResponsavel: nomeResponsavel,
                            nomeSecretaria: nomeSecretaria,
                            urlSecretaria: urlSecretaria
                        })
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        console.warn('‚ö†Ô∏è N√£o foi poss√≠vel enviar email de confirma√ß√£o:', errorData.error);
                        return false;
                    }

                    const result = await response.json();
                    console.log('‚úÖ Email de confirma√ß√£o enviado com sucesso:', result);
                    return true;
                } catch (error) {
                    console.warn('‚ö†Ô∏è Erro ao tentar enviar email de confirma√ß√£o:', error);
                    return false;
                }
            }

            async function notificarControladoria(nomeResponsavel, emailResponsavel, nomeSecretaria, urlSecretaria) {
                try {
                    const response = await fetch('/api/notificar-controladoria', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                        },
                        body: JSON.stringify({
                            nomeResponsavel: nomeResponsavel,
                            emailResponsavel: emailResponsavel,
                            nomeSecretaria: nomeSecretaria,
                            urlSecretaria: urlSecretaria,
                            dataEnvio: new Date().toLocaleDateString('pt-BR') + ' ' + new Date().toLocaleTimeString('pt-BR')
                        })
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        console.warn('‚ö†Ô∏è N√£o foi poss√≠vel notificar a controladoria:', errorData.error);
                        return false;
                    }

                    const result = await response.json();
                    console.log('‚úÖ Controladoria notificada com sucesso:', result);
                    return true;
                } catch (error) {
                    console.warn('‚ö†Ô∏è Erro ao tentar notificar a controladoria:', error);
                    return false;
                }
            }
            
            enviarAvaliacaoBtn.addEventListener('click', async () => {
                const urlSecretaria = urlManualInput.value.trim();
                const nomeResponsavel = nomeResponsavelInput.value.trim();
                const emailResponsavel = emailResponsavelInput.value.trim();
                const secretariaDisplay = document.getElementById('secretaria-display').textContent;

                if (!secretariaHiddenInput.value || !nomeResponsavel || !emailResponsavel) {
                    Swal.fire({
                        icon: 'error',
                        title: 'Campos Obrigat√≥rios',
                        text: 'Por favor, preencha todos os campos de identifica√ß√£o no Passo 1.',
                        confirmButtonColor: 'var(--azul-gov-principal)'
                    });
                    return;
                }

                const confirmacao = await Swal.fire({
                    title: 'Confirmar Envio da Avalia√ß√£o',
                    html: `
                        <div style="text-align: left;">
                            <p><strong>Voc√™ est√° prestes a enviar a avalia√ß√£o com os seguintes dados:</strong></p>
                            <ul style="text-align: left; margin-left: 20px;">
                                <li><strong>√ìrg√£o:</strong> ${secretariaDisplay}</li>
                                <li><strong>URL Avaliada:</strong> ${urlSecretaria}</li>
                                <li><strong>Respons√°vel:</strong> ${nomeResponsavel}</li>
                                <li><strong>E-mail:</strong> ${emailResponsavel}</li>
                            </ul>
                            <p style="margin-top: 15px; color: #dc3545; font-weight: bold;">
                                ‚ö†Ô∏è Ap√≥s o envio, n√£o ser√° poss√≠vel editar a avalia√ß√£o.
                            </p>
                        </div>
                    `,
                    icon: 'question',
                    iconColor: 'var(--azul-gov-principal)',
                    showCancelButton: true,
                    confirmButtonText: 'Sim, Enviar Avalia√ß√£o',
                    cancelButtonText: 'Cancelar',
                    confirmButtonColor: 'var(--verde-sucesso)',
                    cancelButtonColor: 'var(--vermelho-destaque)',
                    reverseButtons: true
                });

                if (!confirmacao.isConfirmed) {
                    return; 
                }

                enviarAvaliacaoBtn.disabled = true;
                enviarAvaliacaoBtn.textContent = 'Enviando...';

                try {
                    let formValido = true;
                    const respostas = [];
                    const requisitoCards = document.querySelectorAll('.requisito-card');
                    
                    for (const card of requisitoCards) {
                        const requisitoId = parseInt(card.dataset.requisitoId);
                        const foiAutomatico = card.dataset.foiAutomatico === 'true';
                        
                        const simBtn = card.querySelector(`[data-action="sim-${requisitoId}"]`);
                        const atende = simBtn ? simBtn.classList.contains('active') : false;

                        const comentarioSecretaria = card.querySelector('.secretaria-comment')?.value.trim() || null;
                        const evidencias = [];
                        let linkComprovante = null;

                        if (foiAutomatico) {
                            linkComprovante = card.querySelector('.link-input')?.value.trim() || null;
                        } else {
                            card.querySelectorAll('.evidence-item').forEach(item => {
                                if (item.dataset.link) {
                                    evidencias.push({ url: item.dataset.link, tipo: 'original' });
                                }
                            });

                            if (atende && evidencias.length === 0) {
                                Swal.fire({ 
                                    icon: 'warning', 
                                    title: 'Evid√™ncia Faltando', 
                                    text: `O requisito "${card.querySelector('.requisito-header span')?.textContent || `ID ${requisitoId}`}" foi marcado como 'Sim', mas nenhuma evid√™ncia foi adicionada.` 
                                });
                                formValido = false;
                                break; 
                            }
                        }

                        respostas.push({
                            requisitoId,
                            foiAutomatico,
                            atende,
                            comentarioSecretaria,
                            evidencias, 
                            linkComprovante
                        });
                    } 

                    if (!formValido) {
                        enviarAvaliacaoBtn.disabled = false;
                        enviarAvaliacaoBtn.textContent = 'Enviar Avalia√ß√£o';
                        return; 
                    }
                    
                    const payload = {
                        urlSecretaria: urlSecretaria, 
                        nomeResponsavel: nomeResponsavel, 
                        emailResponsavel: emailResponsavel, 
                        respostas: respostas.map(r => ({
                            requisitoId: r.requisitoId,
                            atende: r.atende,
                            linkComprovante: r.linkComprovante,
                            foiAutomatico: r.foiAutomatico,
                            comentarioSecretaria: r.comentarioSecretaria,
                            evidencias: r.evidencias 
                        }))
                    };

                    console.log('üì§ Enviando payload para /api/avaliacoes (SIMPLIFICADO):', JSON.stringify(payload));

                    const response = await fetch('/api/avaliacoes', {
                        method: 'POST',
                        headers: { 
                            'Content-Type': 'application/json', 
                            'Authorization': `Bearer ${localStorage.getItem('authToken')}` 
                        },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        const errData = await response.json();
                        throw new Error(errData.error || 'Ocorreu um erro no servidor.');
                    }

                    limparRascunho();

                    await notificarControladoria(
                        nomeResponsavel,
                        emailResponsavel,
                        secretariaDisplay,
                        urlSecretaria
                    );
                    
                    const emailEnviado = await enviarEmailConfirmacao(
                        emailResponsavel,
                        nomeResponsavel,
                        secretariaDisplay,
                        urlSecretaria
                    );

                    document.querySelector('.container').innerHTML = `
                        <div style="text-align: center; padding: 40px;">
                            <h2 style="color: var(--verde-sucesso);">Avalia√ß√£o Enviada com Sucesso!</h2>
                            <p>Obrigado por preencher o formul√°rio. A equipe da SCGE ser√° notificada.</p>
                            ${emailEnviado ? 
                                `<p>Um email de confirma√ß√£o foi enviado para <strong>${emailResponsavel}</strong>.</p>` : 
                                `<p style="color: #666;"><em>Seu formul√°rio foi enviado com sucesso.</em></p>`
                            }
                            <a href="/dashboard" class="btn">Ir para Minha √Årea</a>
                        </div>
                    `;

                } catch (error) {
                    if (error.message && !error.message.includes('Formul√°rio inv√°lido')) { 
                        Swal.fire({
                            icon: 'error',
                            title: 'Erro no Envio!',
                            text: `Erro ao enviar: ${error.message}`,
                            confirmButtonColor: 'var(--vermelho-destaque)'
                        });
                    }
                    enviarAvaliacaoBtn.disabled = false;
                    enviarAvaliacaoBtn.textContent = 'Enviar Avalia√ß√£o';
                }
            });

            populateSecretarias();
        });
    </script>
    <script src="/global.js"></script>
</body>
</html>