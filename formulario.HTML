<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Formul√°rio de Autoavalia√ß√£o - An√°lise PE</title>
    <style>
        
        :root {
            --azul-gov-principal: #002776;
            --amarelo-gov-detalhe: #FFD700;
            --cinza-texto: #333333;
            --cinza-fundo: #f4f4f4;
            --branco: #ffffff;
            --verde-sucesso: #28a745;
            --cinza-borda: #ddd;
        }
        body { margin: 0; font-family: 'Segoe UI', Arial, sans-serif; background-color: var(--cinza-fundo); color: var(--cinza-texto); line-height: 1.6; }
        .main-header { background-color: var(--branco); box-shadow: 0 2px 5px rgba(0,0,0,0.1); padding: 0 5%; position: sticky; top: 0; z-index: 1000; }
        .main-nav { display: flex; justify-content: space-between; align-items: center; height: 70px; max-width: 1200px; margin: 0 auto; }
        .logo a { text-decoration: none; display: flex; align-items: center; gap: 12px; }
        .logo img { height: 45px; filter: drop-shadow(1px 1px 2px rgba(0, 0, 0, 1.2));}
        .logo .site-title { color: var(--azul-gov-principal); font-size: 1.2em; font-weight: bold; line-height: 1.2; }
        .logo .site-subtitle { color: var(--cinza-texto); font-size: 0.8em; display: block; }
        .main-nav ul { list-style: none; margin: 0; padding: 0; display: flex; gap: 20px; }
        .main-nav a { text-decoration: none; color: var(--cinza-texto); font-weight: 600; padding: 10px; border-bottom: 2px solid transparent; transition: all 0.3s ease; }
        .main-nav a:hover, .main-nav a.active { color: var(--azul-gov-principal); border-bottom-color: var(--amarelo-gov-detalhe); }
        .main-footer { text-align: center; padding: 20px; margin-top: 40px; background-color: var(--branco); font-size: 0.9em; position: relative; height: 60px; }
        .main-footer .footer-content { display: flex; justify-content: center; align-items: center; height: 100%; }
        .main-footer img { height: 55px; width: auto; position: absolute; right: 5%; top: 50%; transform: translateY(-50%); }
        main { padding: 40px 5%; }
        .container { max-width: 900px; margin: 0 auto; background: var(--branco); padding: 30px 40px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .form-section { margin-bottom: 40px; padding-bottom: 20px; border-bottom: 1px solid #eee; }
        .form-section h2 { color: var(--azul-gov-principal); border-bottom: 2px solid var(--amarelo-gov-detalhe); padding-bottom: 10px; margin-bottom: 20px; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; font-weight: 600; margin-bottom: 8px; }
        .form-group input[type="text"],
        .form-group input[type="email"],
        .form-group input[type="url"],
        .form-group select { width: 100%; box-sizing: border-box; padding: 12px; border: 1px solid var(--cinza-borda); border-radius: 6px; font-size: 1em; }
        .btn { padding: 12px 25px; background-color: var(--azul-gov-principal); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 1em; font-weight: bold; transition: background-color .3s; }
        .btn:hover { background-color: #001a4d; }
        .btn:disabled { background-color: #ccc; cursor: not-allowed; }
        #requisitos-container { margin-top: 20px; }
        .requisito-card { border: 1px solid var(--cinza-borda); border-radius: 8px; margin-bottom: 20px; overflow: hidden; }
        .requisito-header { background-color: #e9eef5; padding: 15px; font-weight: bold; }
        .requisito-body { padding: 15px; background-color: var(--branco); }
        .requisito-ajuda { font-size: 0.9em; color: #555; background-color: #fafafa; padding: 10px; border-radius: 4px; margin-bottom: 15px; }
        .requisito-actions { display: flex; gap: 10px; align-items: center; }
        .btn-toggle { padding: 8px 16px; border: 1px solid var(--cinza-borda); background-color: var(--branco); border-radius: 20px; cursor: pointer; font-weight: 600; }
        .btn-toggle.active { background-color: var(--verde-sucesso); color: var(--branco); border-color: var(--verde-sucesso); }
        .link-comprovante-wrapper { display: none; flex-grow: 1; }
        .link-comprovante-wrapper.show { display: block; }
        .download-guide { background-color: #e9eef5; padding: 15px; border-radius: 6px; margin-bottom: 30px; text-align: center; }
        .download-guide a { font-weight: bold; color: var(--azul-gov-principal); text-decoration: none; }
        .download-guide a:hover { text-decoration: underline; }

        .progress-bar {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 50px;
            position: relative;
        }
        
        .progress-bar::before {
            content: '';
            position: absolute;
            top: 15px; 
            left: 15%;
            right: 15%;
            height: 2px;
            background-color: var(--cinza-borda);
            z-index: 0;
        }
        .step {
            text-align: center;
            position: relative;
            z-index: 1; 
            width: 120px;
        }
        .step-number {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background-color: var(--cinza-fundo);
            color: var(--cinza-texto);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            border: 2px solid var(--cinza-borda);
            transition: background-color 0.4s, border-color 0.4s, color 0.4s;
        }
        .step-label {
            margin-top: 8px;
            font-size: 0.9em;
            color: #999;
            transition: color 0.4s;
        }
       
        .step.active .step-number {
            background-color: var(--azul-gov-principal);
            border-color: var(--azul-gov-principal);
            color: var(--branco);
        }
        .step.active .step-label {
            color: var(--azul-gov-principal);
            font-weight: bold;
        }

        .disabled-link {
            cursor: not-allowed; 
        }

    </style>
</head>
<body>
    <header class="main-header">
        <nav class="main-nav">
            <div class="logo"><a href="/"><img src="/assets/logo-header.png" alt="Logo do Governo de Pernambuco"><div><span class="site-title">An√°lise de Sites</span><span class="site-subtitle">Portal da Transpar√™ncia</span></div></a></div>
            <ul>
                <li><a href="/">In√≠cio</a></li>
                <li><a href="/scanner">Scanner de Links</a></li>
                <li><a href="#" class="disabled-link">Autoavalia√ß√£o</a></li>
            </ul>
        </nav>
    </header>

    <main>
        <div class="container">
            <div class="progress-bar">
                <div class="step active" id="progress-step-1">
                    <div class="step-number">1</div>
                    <div class="step-label">Identifica√ß√£o</div>
                </div>
                <div class="step" id="progress-step-2">
                    <div class="step-number">2</div>
                    <div class="step-label">Pr√©-Valida√ß√£o</div>
                </div>
                <div class="step" id="progress-step-3">
                    <div class="step-number">3</div>
                    <div class="step-label">Preenchimento</div>
                </div>
            </div>          
            <div class="download-guide">
                <p style="margin:0;">üìÑ Precisa de ajuda? <a href="/assets/guia-transparencia.pdf" download>Clique aqui para baixar o Guia de Transpar√™ncia Ativa.</a></p>
            </div>
            <div class="form-section">
                <h2>Passo 1: Identifica√ß√£o</h2>
                <div class="form-group">
                    <label for="secretaria-select">Selecione o √ìrg√£o/Entidade</label>
                    <select id="secretaria-select"><option value="">Carregando...</option></select>
                </div>
                <div class="form-group">
                    <label for="url-manual">URL do Site a ser Avaliado</label>
                    <input type="url" id="url-manual" placeholder="https://www.sitedasecretaria.pe.gov.br">
                </div>
                <div class="form-group">
                    <label for="responsavel-nome">Nome do Respons√°vel pelo preenchimento</label>
                    <input type="text" id="responsavel-nome" placeholder="Digite seu nome completo">
                </div>
                <div class="form-group">
                    <label for="responsavel-email">E-mail do Respons√°vel</label>
                    <input type="email" id="responsavel-email" placeholder="Digite seu e-mail para contato">
                </div>
            </div>



            <div class="form-section">
                <h2>Passo 2: Pr√©-Valida√ß√£o Autom√°tica</h2>
                <p>Antes de come√ßar, nossa ferramenta pode verificar automaticamente alguns requisitos para voc√™. Clique no bot√£o abaixo para iniciar a verifica√ß√£o no site da secretaria selecionada.</p>
                <button id="pre-validar-btn" class="btn">Iniciar Pr√©-Valida√ß√£o</button>
                <div id="pre-validacao-resultado" style="margin-top: 15px;"></div>
            </div>

            <div class="form-section">
                <h2>Passo 3: Preenchimento dos Requisitos</h2>
                <div id="requisitos-container"><p>Aguardando a pr√©-valida√ß√£o para carregar os requisitos...</p></div>
            </div>
            
            <div style="text-align: right;">
                <button id="enviar-avaliacao-btn" class="btn" disabled>Enviar Avalia√ß√£o</button>
            </div>
        </div>
    </main>

    <footer class="main-footer">
        <div class="footer-content">
             <img src="/assets/logo-footer.png" alt="Logo da Controladoria-Geral do Estado de Pernambuco">
             <p>&copy; 2025 Governo de Pernambuco. Todos os direitos reservados. | <a href="#" class="disabled-link">√Årea Administrativa</a></p>
        </div>
    </footer>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        document.querySelectorAll('.disabled-link').forEach(link => {
            link.addEventListener('click', (event) => {
                event.preventDefault(); 
                alert('Indispon√≠vel no momento');
            });
        });

        const secretariaSelect = document.getElementById('secretaria-select');
        const urlManualInput = document.getElementById('url-manual');
        const nomeResponsavelInput = document.getElementById('responsavel-nome');
        const emailResponsavelInput = document.getElementById('responsavel-email');
        const preValidarBtn = document.getElementById('pre-validar-btn');
        const preValidacaoResultado = document.getElementById('pre-validacao-resultado');
        const requisitosContainer = document.getElementById('requisitos-container');
        const enviarAvaliacaoBtn = document.getElementById('enviar-avaliacao-btn');
        
        let todosOsRequisitos = [];
        let linksEncontradosAutomaticamente = [];

        async function populateSecretarias() {
            try {
                const response = await fetch('http://localhost:3000/secretarias');
                if (!response.ok) throw new Error('N√£o foi poss√≠vel carregar a lista de secretarias.');
                const secretarias = await response.json();
                secretariaSelect.innerHTML = '<option value="">-- Selecione uma op√ß√£o --</option>';
                secretarias.forEach(secretaria => {
                    const option = document.createElement('option');
                    option.value = secretaria.id;
                    option.textContent = `${secretaria.nome} (${secretaria.sigla})`;
                    secretariaSelect.appendChild(option);
                });
            } catch (error) {
                console.error(error);
                secretariaSelect.innerHTML = '<option value="">Erro ao carregar a lista</option>';
            }
        }

        async function renderRequisitos(linksEncontrados) {
            try {
                requisitosContainer.innerHTML = '<p>Carregando requisitos...</p>';
                const response = await fetch('http://localhost:3000/requisitos');
                if (!response.ok) throw new Error('Falha ao buscar os requisitos.');
                todosOsRequisitos = await response.json();
                requisitosContainer.innerHTML = '';

                todosOsRequisitos.forEach(req => {
                    const resultadoEncontrado = linksEncontrados.find(res => res.alvo === req.linkFixo);
                    const isAutoValidated = !!resultadoEncontrado;
                    const requisitoCard = document.createElement('div');
                    requisitoCard.className = 'requisito-card';
                    requisitoCard.dataset.requisitoId = req.id;
                    
                    let actionsHTML = '';
                    if (isAutoValidated) {
                        requisitoCard.dataset.foiAutomatico = 'true';
                        actionsHTML = `
                            <div class="requisito-actions">
                                <button class="btn-toggle active" data-atende="true">Sim</button>
                                <button class="btn-toggle" data-atende="false">N√£o</button>
                                <div class="link-comprovante-wrapper show">
                                    <input type="url" class="link-input" value="${req.linkFixo}" readonly style="width: 100%; padding: 8px; background-color: #e9e9e9;">
                                </div>
                            </div>
                            <div style="font-size: 0.9em; margin-top: 10px;">
                                <span style="color: var(--verde-sucesso); font-weight: bold;">‚úîÔ∏è Verificado Automaticamente</span><br>
                                <span class="link-meta"><strong>Encontrado em:</strong> <a href="${resultadoEncontrado.origem}" target="_blank">${resultadoEncontrado.origem}</a></span>
                            </div>
                        `;
                    } else {
                        requisitoCard.dataset.foiAutomatico = 'false';
                        actionsHTML = `
                            <div class="requisito-actions">
                                <span>Atende ao requisito?</span>
                                <button class="btn-toggle" data-action="sim" data-atende="true">Sim</button>
                                <button class="btn-toggle" data-action="nao" data-atende="false">N√£o</button>
                                <div class="link-comprovante-wrapper">
                                    <input type="url" class="link-input" placeholder="Cole o link de comprova√ß√£o aqui" style="width: 100%; padding: 8px;">
                                </div>
                            </div>
                        `;
                    }
                    requisitoCard.innerHTML = `
                        <div class="requisito-header">
                            <span>${req.texto} (Pontua√ß√£o: ${req.pontuacao})</span>
                        </div>
                        <div class="requisito-body">
                            <div class="requisito-ajuda">
                                <strong>Guia:</strong> ${req.textoAjuda}
                            </div>
                            ${actionsHTML}
                        </div>
                    `;
                    requisitosContainer.appendChild(requisitoCard);
                });
                enviarAvaliacaoBtn.disabled = false;
            } catch (error) {
                console.error(error);
                requisitosContainer.innerHTML = '<p style="color: red;">Erro ao carregar os requisitos.</p>';
            }
        }

        preValidarBtn.addEventListener('click', async () => {
            const urlParaVerificar = document.getElementById('url-manual').value.trim();
            if (!urlParaVerificar) {
                alert('Por favor, digite a URL do site a ser avaliado.');
                return;
            }
            preValidarBtn.disabled = true;
            preValidarBtn.textContent = 'Verificando...';
            preValidacaoResultado.innerHTML = '<p>Iniciando varredura no site... Isso pode levar alguns minutos.</p>';
            try {
                const response = await fetch('http://localhost:3000/pre-validate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ urlSecretaria: urlParaVerificar }),
                });
                if (!response.ok) throw new Error('O servidor retornou um erro durante a pr√©-valida√ß√£o.');
                const resultado = await response.json();
                linksEncontradosAutomaticamente = resultado;
                preValidacaoResultado.innerHTML = `<h4>Verifica√ß√£o Autom√°tica Conclu√≠da!</h4><p>Foram encontrados <strong>${linksEncontradosAutomaticamente.length}</strong> links obrigat√≥rios.</p>`;
                await renderRequisitos(linksEncontradosAutomaticamente);
            } catch (error) {
                console.error('Erro na pr√©-valida√ß√£o:', error);
                preValidacaoResultado.innerHTML = `<p style="color: red;">Ocorreu um erro: ${error.message}</p>`;
            } finally {
                preValidarBtn.disabled = false;
                preValidarBtn.textContent = 'Iniciar Pr√©-Valida√ß√£o';
            }
        });

        requisitosContainer.addEventListener('click', (event) => {
            const target = event.target;
            if (target.matches('.btn-toggle[data-action]')) {
                const parentActions = target.closest('.requisito-actions');
                const linkWrapper = parentActions.querySelector('.link-comprovante-wrapper');
                const simBtn = parentActions.querySelector('[data-action="sim"]');
                const naoBtn = parentActions.querySelector('[data-action="nao"]');

                if (target.dataset.action === 'sim') {
                    simBtn.classList.add('active');
                    naoBtn.classList.remove('active');
                    linkWrapper.classList.add('show');
                } else if (target.dataset.action === 'nao') {
                    naoBtn.classList.add('active');
                    simBtn.classList.remove('active');
                    linkWrapper.classList.remove('show');
                }
            }
        });
    
        enviarAvaliacaoBtn.addEventListener('click', async () => {
            enviarAvaliacaoBtn.disabled = true;
            enviarAvaliacaoBtn.textContent = 'Enviando...';
            try {
                const secretariaId = secretariaSelect.value;
                const urlSecretaria = urlManualInput.value.trim();
                const nomeResponsavel = nomeResponsavelInput.value.trim();
                const emailResponsavel = emailResponsavelInput.value.trim();

                if (!secretariaId || !nomeResponsavel || !emailResponsavel) {
                    alert('Por favor, preencha todos os campos de identifica√ß√£o.');
                    throw new Error('Campos de identifica√ß√£o incompletos.');
                }

                const respostas = [];
                const requisitoCards = document.querySelectorAll('.requisito-card');
                
                requisitoCards.forEach(card => {
                    const requisitoId = parseInt(card.dataset.requisitoId);
                    const foiAutomatico = card.dataset.foiAutomatico === 'true';
                    const simBtn = card.querySelector('[data-atende="true"]');
                    const linkInput = card.querySelector('.link-input');
                    const atende = simBtn.classList.contains('active');
                    const linkComprovante = atende ? (linkInput ? linkInput.value.trim() : null) : null;

                    respostas.push({ requisitoId, atende, linkComprovante, foiAutomatico });
                });
                
                const payload = {
                    secretariaId, urlSecretaria, nomeResponsavel, emailResponsavel, respostas
                };

                const response = await fetch('http://localhost:3000/avaliacoes', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    throw new Error('Ocorreu um erro no servidor ao tentar salvar a avalia√ß√£o.');
                }
                document.querySelector('.container').innerHTML = `
                    <div style="text-align: center; padding: 40px;">
                        <h2 style="color: var(--verde-sucesso);">Avalia√ß√£o Enviada com Sucesso!</h2>
                        <p>Obrigado por preencher o formul√°rio. A equipe da SCGE foi notificada e ir√° analisar suas respostas.</p>
                        <a href="/" class="btn">Voltar para o In√≠cio</a>
                    </div>
                `;
            } catch (error) {
                alert(`Erro ao enviar: ${error.message}`);
                enviarAvaliacaoBtn.disabled = false;
                enviarAvaliacaoBtn.textContent = 'Enviar Avalia√ß√£o';
            }
        });

        populateSecretarias();
    });
</script>
</body>
</html>