generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model ScanSession {
  id           String    @id @default(uuid())
  url_base     String
  status       String    @default("iniciado")
  total_links  Int       @default(0)
  depthReached Int?
  errorMessage String?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  links        Link[]    @relation("SessionLinks")
}

model Link {
  id              Int       @id @default(autoincrement())
  url             String
  finalUrl        String?
  tipo            String
  origem          String
  status          String
  httpCode        Int?
  responseTime    Int?
  profundidade    Int?
  session_id      String
  createdAt       DateTime  @default(now())
  session         ScanSession @relation("SessionLinks", fields: [session_id], references: [id], onDelete: Cascade)

  @@unique([url, session_id])
  @@index([session_id])
}

model Requisito {
  id          Int      @id @default(autoincrement())
  texto       String
  textoAjuda  String?
  linkFixo    String?
  pontuacao   Int
  respostas   Resposta[]
}

model Avaliacao {
  id               Int               @id @default(autoincrement())
  urlSecretaria    String
  nomeResponsavel  String
  emailResponsavel String
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @default(now()) @updatedAt
  prazoRecurso         DateTime?  
  recursoExpirado      Boolean   @default(false)
  status           AvaliacaoStatus   @default(PENDENTE_SECRETARIA) 
  ciclo            Int               @default(2025)
  pontuacaoFinal   Float?  
  secretaria       Secretaria        @relation(fields: [secretariaId], references: [id])
  secretariaId     Int
  respostas        Resposta[]

  pontuacaoAutoavaliacao  Float? 
  pontuacaoPrimeiraAnalise Float? 
  pontuacaoPosRecurso      Float? 
  pontuacaoTotal           Float? 
  dataFinalizacao          DateTime?
}

model Resposta {
  id                        Int      @id @default(autoincrement())
  atende                    Boolean
  foiAutomatico             Boolean  @default(false)
  linkComprovante String?
  linkComprovanteRecurso String?
  
  
  comentarioAdmin           String?
  comentarioSecretaria      String?
  comentarioRecurso         String?
 

  statusRecurso             String?
  statusValidacao           String   @default("pendente")
  statusValidacaoPosRecurso           String?

  recursoAtende             Boolean?
  analiseFinal              Json?
  atendeOriginal            Boolean? 

  requisito                 Requisito @relation(fields: [requisitoId], references: [id])
  requisitoId               Int
  avaliacao                 Avaliacao @relation(fields: [avaliacaoId], references: [id], onDelete: Cascade)
  avaliacaoId               Int
  evidencias                Evidencia[]
}

model Secretaria {
  id         Int         @id @default(autoincrement())
  nome       String      @unique
  sigla      String      @unique
  url        String
  avaliacoes Avaliacao[]
  users      User[]
}

model User {
  id           Int        @id @default(autoincrement())
  email        String     @unique
  password     String     
  nome         String
  role         String     @default("SECRETARIA")
  createdAt    DateTime   @default(now())
  secretaria   Secretaria @relation(fields: [secretariaId], references: [id])
  secretariaId Int
}

model CodigoVerificacao {
  id        Int      @id @default(autoincrement())
  email     String
  codigo    String
  tipo      String   
  expiraEm  DateTime
  usado     Boolean  @default(false)
  createdAt DateTime @default(now())
  
  @@index([email, tipo])
}

enum AvaliacaoStatus {
  PENDENTE_SECRETARIA
  EM_ANALISE_SCGE
  AGUARDANDO_RECURSO
  EM_ANALISE_DE_RECURSO
  FINALIZADA
}

model Evidencia {
  id          Int      @id @default(autoincrement())
  tipo       String   @default("original")
  url         String   
  createdAt   DateTime @default(now())
  resposta    Resposta @relation(fields: [respostaId], references: [id], onDelete: Cascade)
  respostaId  Int
}